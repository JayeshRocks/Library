<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Bree+Serif&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <style>
        /* Styling goes here */
    </style>

    <script>
        function changePage(page) {
            google.script.run.withSuccessHandler((response) => {
                document.open();
                document.write(response);
                document.close();
            }).newPage(page);
        }

        function checkExistingUser() {
            const email = $("#userEmail").val();
            const uname = $("#username").val();

            if (email || uname) {
                google.script.run.withSuccessHandler((response) => {
                    M.toast({ html: response.exists ? response.message : "User not found, proceeding to send OTP" });
                    if (!response.exists) sendOTP();
                }).checkUserExists(email, uname);
            } else {
                M.toast({ html: "Please enter an email or username!" });
            }
        }

        function sendOTP() {
            const email = $("#userEmail").val();

            if (email) {
                google.script.run.withSuccessHandler((response) => {
                    M.toast({ html: response.success ? "OTP sent to your email!" : response.message });
                    if (response.success) $("#otpSection").show();
                }).sendOTP(email);
            } else {
                M.toast({ html: "Please enter your email!" });
            }
        }

        function verifyOTP() {
            const otpInput = $("#otpInput").val();
            const email = $("#userEmail").val();

            if (otpInput) {
                google.script.run.withSuccessHandler((response) => {
                    M.toast({ html: response.success ? "OTP verified! Please set your password." : response.message });
                    if (response.success) $("#passwordSection").show();
                }).verifyOTP(email, otpInput);
            } else {
                M.toast({ html: "Please enter the OTP!" });
            }
        }

        function createPassword() {
            const email = $("#userEmail").val();
            const password = $("#passwordInput").val();
            const uname = $("#username").val();

            if (password) {
                google.script.run.withSuccessHandler((response) => {
                    M.toast({ html: response.success ? "Account created successfully!" : response.message });
                    if (response.success) changePage('Login');
                }).createPassword(email, password, uname);
            } else {
                M.toast({ html: "Please enter a password!" });
            }
        }

        $(document).ready(function () {
            // Hide OTP and Password sections initially
            $("#otpSection, #passwordSection").hide();
        });
    </script>
</head>

<body>
<div class="container">
    <div class="row center-align">
        <div class="col s12">
            <h1><u>O</u>nline <u>L</u>ibrary</h1>
            <h4>Create Your Account</h4>
        </div>
    </div>
    <div class="row center-align">
        <div class="col s12 m8 l6 offset-m2 offset-l3 card">
            <div class="card-content">
                <div class="input-field col s12">
                    <input id="username" type="text" required placeholder="Enter your username...">
                    <label for="username">Username</label>
                </div>
                <div class="input-field col s12">
                    <input id="userEmail" type="email" required placeholder="Enter your email...">
                    <label for="userEmail">Email</label>
                </div>
                <button class="waves-effect btn blue" onclick="checkExistingUser()">Send OTP</button>
                <div id="otpSection" style="display: none; margin-top: 20px;">
                    <div class="input-field col s12">
                        <input id="otpInput" type="text" required placeholder="Enter OTP...">
                        <label for="otpInput">OTP</label>
                    </div>
                    <button class="waves-effect btn blue" onclick="verifyOTP()">Verify OTP</button>
                </div>
                <div id="passwordSection" style="display: none; margin-top: 20px;">
                    <div class="input-field col s12">
                        <input id="passwordInput" type="password" required placeholder="Create a password...">
                        <label for="passwordInput">Password</label>
                    </div>
                    <button class="waves-effect btn blue" onclick="createPassword()">Set Password</button>
                </div>
                <div class="center-align" style="margin-top: 20px;">
                    <button class="elink" onclick="changePage('Login')">Already have an account? Log In</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

</html>
